sudo: required
language: node_js
node_js: 
    - "node"

services:
    - docker

install: npm install

script: 
    - npm run build

after_success:
    - export REPO="us.gcr.io/brave-reason-142805/blogui"
    - docker login -e="$DOCKER_EMAIL" -u="$DOCKER_USERNAME" -p "$(cat keyfile.json)" $REPO;
    - export V="latest"
    - docker build -f Dockerfile -t $REPO:$V .
    - docker images
    - gcloud docker --authorize-only
    - docker push $REPO:$V

deploy:
    - gcloud components update kubectl
    - export $SERVICE_NAME="blog-ui1"
    - export $EX_SERVICES="(gcloud container clusters list --filter='blog-ui')"
    - if [[ "$EX_SERVICES" != "blog-ui1" ]]; then gcloud container clusters create blog-ui;
    - kubectl run blog-ui --image=us.gcr.io/brave-reason-142805/blogui/ --port=8080
    - kubectl expose deployment blog-ui1 --type="LoadBalancer"
    